upstream backend {
    server backend:8000;
}

upstream frontend {
    server frontend:80;
}

server {
    listen 80;
    server_name _; 

    # --- 安全头 ---
    # 允许 Cloudflare 代理，防止被认为是欺骗
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always; # 改为 SAMEORIGIN 以允许同源 iframe (如有需要)
    add_header X-XSS-Protection "1; mode=block" always;

    # --- 1. 后端 API 转发 (核心) ---
    # FastAPI 路由已经是 /api/v1/...，不需要 rewrite，直接转发
    location /api/ {
        proxy_pass http://backend;

        # 标准代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 【AI 专用】超时设置
        # Multi-agent tasks can take up to 10 minutes (600s)
        # Increased from 300s to 600s to support complex multi-agent workflows
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
        
        # Client timeouts (prevent client disconnection during long AI tasks)
        client_body_timeout 600s;
        client_header_timeout 600s;
        keepalive_timeout 600s;

        # 【AI 专用】流式传输支持 (Server-Sent Events / Streaming)
        # 关闭缓冲，让 AI 的字一个一个蹦出来，而不是等全写完再一次性发
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
    }

    # --- 2. Swagger 文档 (可选) ---
    # FastAPI 文档在 /docs，不在 /api/ 下
    location /docs {
        proxy_pass http://backend/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /openapi.json {
        proxy_pass http://backend/openapi.json;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /redoc {
        proxy_pass http://backend/redoc;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- 3. 后端健康检查 (直接转发到后端) ---
    location /health {
        proxy_pass http://backend/health;
        proxy_set_header Host $host;
        access_log off;
    }

    # --- 4. 前端静态文件和 SPA 路由 ---
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 针对 WebSocket 的支持 (如果前端用了 HMR 或 WebSocket)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # SPA 路由支持：前端 Nginx 会处理 try_files，这里只是代理
        # 如果前端返回 404，nginx 会返回 index.html（由前端 nginx 配置处理）
    }
}