upstream backend {
    server backend:8000;
}

upstream frontend {
    server frontend:80;
}

# Polymatrix 子站：https://polymatrix.thetamind.ai/ -> 宿主机 8501（非本 compose 服务）
upstream polymatrix {
    server host.docker.internal:8501;
}

server {
    listen 80;
    server_name _;

    # 长 AI 任务：允许客户端保持连接 10 分钟（仅在此 server 生效）
    client_body_timeout 600s;
    client_header_timeout 600s;

    # --- 安全头 ---
    # 允许 Cloudflare 代理，防止被认为是欺骗
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always; # 改为 SAMEORIGIN 以允许同源 iframe (如有需要)
    add_header X-XSS-Protection "1; mode=block" always;

    # --- 1. 后端 API 转发 (核心) ---
    # FastAPI 路由已经是 /api/v1/...，不需要 rewrite，直接转发
    location /api/ {
        proxy_pass http://backend;

        # 标准代理头
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # 【AI 专用】超时设置（proxy_* 可放在 location；client_* / keepalive 须在 http/server）
        # Multi-agent tasks can take up to 10 minutes (600s)
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        # 【AI 专用】流式传输支持 (Server-Sent Events / Streaming)
        # 关闭缓冲，让 AI 的字一个一个蹦出来，而不是等全写完再一次性发
        proxy_buffering off;
        proxy_cache off;
        chunked_transfer_encoding on;
    }

    # --- 2. Swagger 文档 (可选) ---
    # FastAPI 文档在 /docs，不在 /api/ 下
    location /docs {
        proxy_pass http://backend/docs;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /openapi.json {
        proxy_pass http://backend/openapi.json;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /redoc {
        proxy_pass http://backend/redoc;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # --- 3. 后端健康检查 (直接转发到后端) ---
    location /health {
        proxy_pass http://backend/health;
        proxy_set_header Host $host;
        access_log off;
    }

    # --- 4. 前端：/assets/ 必须只由前端容器提供，不能回退到 HTML（否则刷新会报 MIME 错误）
    location /assets/ {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache off;
        proxy_buffering off;
    }

    # --- 5. 前端 SPA 路由（/、/dashboard、/strategy-lab 等）：返回 index.html，不缓存
    location / {
        proxy_pass http://frontend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache off;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        add_header Cache-Control "no-cache, no-store, must-revalidate" always;
        add_header Pragma "no-cache" always;
        add_header Expires "0" always;
    }
}

# --- Polymatrix 二级域名：https://polymatrix.thetamind.ai/ -> 8501 ---
server {
    listen 80;
    server_name polymatrix.thetamind.ai;

    client_body_timeout 600s;
    client_header_timeout 600s;

    add_header X-Content-Type-Options "nosniff" always;
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-XSS-Protection "1; mode=block" always;

    location / {
        proxy_pass http://polymatrix;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;

        # WebSocket 支持（Streamlit/Gradio 等常用）
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_buffering off;
    }
}